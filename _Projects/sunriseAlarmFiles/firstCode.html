<!-- HTML generated using hilite.me -->
<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">
        1
        2
        3
        4
        5
        6
        7
        8
        9
       10
       11
       12
       13
       14
       15
       16
       17
       18
       19
       20
       21
       22
       23
       24
       25
       26
       27
       28
       29
       30
       31
       32
       33
       34
       35
       36
       37
       38
       39
       40
       41
       42
       43
       44
       45
       46
       47
       48
       49
       50
       51
       52
       53
       54
       55
       56
       57
       58
       59
       60
       61
       62
       63
       64
       65
       66
       67
       68
       69
       70
       71
       72
       73
       74
       75
       76
       77
       78
       79
       80
       81
       82
       83
       84
       85
       86
       87
       88
       89
       90
       91
       92
       93
       94
       95
       96
       97
       98
       99
      100
      101
      102
      103
      104
      105
      106
      107
      108
      109
      110
      111
      112
      113
      114
      115
      116
      117
      118
      119
      120
      121
      122
      123
      124
      125
      126
      127
      128
      129
      130
      131
      132
      133
      134
      135
      136
      137
      138
      139
      140
      141
      142
      143
      144
      145
      146
      147
      148
      149
      150
      151
      152
      153
      154
      155
      156
      157
      158
      159
      160
      161
      162
      163
      164
      165
      166
      167
      168
      169
      170
      171
      172
      173
      174
      175
      176
      177
      178
      179
      180
      181
      182
      183
      184
      185
      186
      187
      188
      189
      190
      191
      192
      193
      194
      195
      196
      197
      198
      199
      200
      201
      202
      203
      204
      205
      206
      207
      208
      209
      210
      211
      212
      213
      214
      215
      216
      217
      218
      219
      220
      221
      222
      223
      224
      225
      226
      227
      228
      229
      230
      231
      232
      233
      234
      235
      236
      237
      238
      239
      240
      241
      242
      243
      244
      245
      246
      247
      248
      249
      250
      251
      252
      253
      254
      255
      256
      257
      258
      259
      260
      261
      262
      263
      264
      265
      266
      267
      268
      269
      270
      271
      272
      273
      274
      275
      276
      277
      278
      279
      280
      281
      282
      283
      284
      285
      286
      287
      288
      289
      290
      291
      292
      293
      294
      295
      296
      297
      298
      299
      300
      301
      302
      303
      304
      305
      306
      307
      308
      309
      310
      311
      312
      313
      314
      315
      316
      317
      318
      319
      320
      321
      322
      323
      324
      325
      326
      327
      328
      329
      330
      331
      332
      333
      334
      335
      336
      337
      338
      339
      340
      341
      342
      343
      344
      345
      346
      347
      348
      349
      350
      351
      352
      353
      354
      355
      356
      357
      358
      359
      360
      361
      362
      363
      364
      365
      366
      367
      368
      369
      370
      371
      372
      373
      374
      375
      376
      377
      378
      379
      380
      381
      382
      383
      384
      385
      386
      387
      388
      389
      390
      391
      392
      393
      394
      395
      396
      397
      398
      399
      400
      401
      402
      403
      404
      405
      406
      407
      408
      409
      410
      411
      412
      413
      414
      415
      416
      417
      418
      419
      420</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &lt;Arduino.h&gt;</span>
      
      <span style="color: #557799">#include &lt;ESP8266WiFi.h&gt;</span>
      <span style="color: #557799">#include &lt;ESP8266WiFiMulti.h&gt;</span>
      <span style="color: #557799">#include &lt;EEPROM.h&gt;</span>
      
      <span style="color: #557799">#include &lt;ESP8266HTTPClient.h&gt;</span>
      
      <span style="color: #557799">#include &lt;TimeLib.h&gt;</span>
      
      <span style="color: #557799">#define USE_SERIAL Serial</span>
      
      <span style="color: #557799">#define ENABLED_ADDR        0</span>
      <span style="color: #557799">#define WEEKEND_HOUR_ADDR   1</span>
      <span style="color: #557799">#define WEEKEND_MINUTE_ADDR 2</span>
      <span style="color: #557799">#define WEEK_HOUR_ADDR      3</span>
      <span style="color: #557799">#define WEEK_MINUTE_ADDR 4</span>
      
      ESP8266WiFiMulti WiFiMulti;
      <span style="color: #333399; font-weight: bold">bool</span> confirmed;
      <span style="color: #333399; font-weight: bold">int</span> last_synced;
      
      <span style="color: #888888">// Create an instance of the server</span>
      <span style="color: #888888">// specify the port to listen on as an argument</span>
      WiFiServer <span style="color: #0066BB; font-weight: bold">server</span>(<span style="color: #0000DD; font-weight: bold">8888</span>);
      
      
      <span style="color: #333399; font-weight: bold">bool</span> enabled;
      <span style="color: #333399; font-weight: bold">int</span> end_hour;
      <span style="color: #333399; font-weight: bold">int</span> end_minute;
      <span style="color: #333399; font-weight: bold">int</span> week_hour;
      <span style="color: #333399; font-weight: bold">int</span> week_minute;
      
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">setup</span>() {
        last_synced <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>;
        <span style="color: #888888">//  day = 0;</span>
        confirmed <span style="color: #333333">=</span> <span style="color: #007020">false</span>;
        pinMode(LED_BUILTIN, OUTPUT);
        digitalWrite(LED_BUILTIN, HIGH);
        pinMode(<span style="color: #0000DD; font-weight: bold">1</span>, OUTPUT);
        analogWriteRange(<span style="color: #0000DD; font-weight: bold">255</span>);
        analogWrite(<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>);
        digitalWrite(LED_BUILTIN, LOW); <span style="color: #888888">// turn on the signal light on boot</span>
      
        USE_SERIAL.begin(<span style="color: #0000DD; font-weight: bold">115200</span>);
        <span style="color: #888888">// USE_SERIAL.setDebugOutput(true);</span>
        delay(<span style="color: #0000DD; font-weight: bold">1000</span>);
      
        <span style="color: #888888">// load config from eeprom</span>
        EEPROM.begin(<span style="color: #0000DD; font-weight: bold">512</span>); <span style="color: #888888">// 512 bytes in EEPROM</span>
        enabled <span style="color: #333333">=</span> EEPROM.read(ENABLED_ADDR);
        end_hour <span style="color: #333333">=</span> EEPROM.read(WEEKEND_HOUR_ADDR);
        end_minute <span style="color: #333333">=</span> EEPROM.read(WEEKEND_MINUTE_ADDR);
        week_hour <span style="color: #333333">=</span> EEPROM.read(WEEK_HOUR_ADDR);
        week_minute <span style="color: #333333">=</span> EEPROM.read(WEEK_MINUTE_ADDR);
      
        USE_SERIAL.flush();
        USE_SERIAL.println();
        USE_SERIAL.println();
        USE_SERIAL.println();
      
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">uint8_t</span> t <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">4</span>; t <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>; <span style="color: #333333">--</span>t) {
          USE_SERIAL.printf(<span style="background-color: #fff0f0">&quot;[SETUP] WAIT %d...</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>, t);
          delay(<span style="color: #0000DD; font-weight: bold">1000</span>);
        }
      
      
        WiFi.hostname(<span style="background-color: #fff0f0">&quot;alarmclock&quot;</span>);
        WiFi.mode(WIFI_STA);
        WiFiMulti.addAP(<span style="background-color: #fff0f0">&quot;butter butter&quot;</span>, <span style="background-color: #fff0f0">&quot;bakedPotatoes&quot;</span>);
      
        <span style="color: #008800; font-weight: bold">while</span> (WiFi.status() <span style="color: #333333">!=</span> WL_CONNECTED) {
          delay(<span style="color: #0000DD; font-weight: bold">1000</span>);
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;.&quot;</span>);
        }
        USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;&quot;</span>);
        USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;WiFi connected&quot;</span>);
        <span style="color: #888888">// Start the server</span>
        server.begin();
        USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;Server started&quot;</span>);
      
        <span style="color: #888888">// Print the IP address</span>
        USE_SERIAL.println(WiFi.localIP());
      }
      
      <span style="color: #333399; font-weight: bold">void</span>(<span style="color: #333333">*</span> resetFunc) (<span style="color: #333399; font-weight: bold">void</span>) <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; <span style="color: #888888">//declare reset function @ address 0</span>
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">loop</span>()
      {
        <span style="color: #008800; font-weight: bold">if</span> ( (timeStatus() <span style="color: #333333">==</span> timeNotSet) <span style="color: #333333">||</span> (last_synced <span style="color: #333333">!=</span> day() <span style="color: #333333">&amp;&amp;</span> hour() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">12</span> <span style="color: #333333">&amp;&amp;</span> minute() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>))
        {
          <span style="color: #888888">// wait for WiFi connection</span>
          <span style="color: #008800; font-weight: bold">if</span> ((WiFiMulti.run() <span style="color: #333333">==</span> WL_CONNECTED))
          {
            HTTPClient http;
      
            USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;[HTTP] begin...</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
            <span style="color: #888888">// configure traged server and url</span>
            <span style="color: #888888">//http.begin(&quot;https://192.168.1.50/test.html&quot;, &quot;7a 9c f4 db 40 d3 62 5a 6e 21 bc 5c cc 66 c8 3e a1 45 59 38&quot;); //HTTPS</span>
            digitalWrite(LED_BUILTIN, LOW);
            http.begin(<span style="background-color: #fff0f0">&quot;http://192.168.1.50/timestamp.php&quot;</span>); <span style="color: #888888">//HTTP</span>
      
            USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;[HTTP] GET...&quot;</span>);
            <span style="color: #888888">// start connection and send HTTP header</span>
            <span style="color: #333399; font-weight: bold">int</span> httpCode <span style="color: #333333">=</span> http.GET();
      
            <span style="color: #888888">// httpCode will be negative on error</span>
            <span style="color: #008800; font-weight: bold">if</span> (httpCode <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>)
            {
              <span style="color: #888888">// HTTP header has been send and Server response header has been handled</span>
              USE_SERIAL.printf(<span style="background-color: #fff0f0">&quot; code: %d</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>, httpCode);
      
              <span style="color: #888888">// file found at server</span>
              <span style="color: #008800; font-weight: bold">if</span> (httpCode <span style="color: #333333">==</span> HTTP_CODE_OK)
              {
                String payload <span style="color: #333333">=</span> http.getString();
                USE_SERIAL.println(payload);
      
                <span style="color: #888888">//          int day = last_synced = get_day(payload);</span>
                <span style="color: #888888">//          int hour = get_hour(payload);</span>
                <span style="color: #888888">//          int minute = get_min(payload);</span>
                <span style="color: #888888">//          int second = get_sec(payload);</span>
      
                <span style="color: #888888">//          StartTime = millis();</span>
                setTime(get_hour(payload), get_minute(payload), get_second(payload), get_date(payload), get_month(payload), get_year(payload));
                last_synced <span style="color: #333333">=</span> get_date(payload);
                <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>confirmed)
                {
                  confirmed <span style="color: #333333">=</span> <span style="color: #007020">true</span>;
                  <span style="color: #008800; font-weight: bold">if</span> (hour() <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">12</span>)
                  {
                    <span style="color: #333333">--</span>last_synced;
                  }
                }
                digitalWrite(LED_BUILTIN, HIGH);
                send_time();
      
                set_alarm();
      
              }
              http.end();
              <span style="color: #888888">// delay(10000); // todo: change back to 60??</span>
            }
            <span style="color: #008800; font-weight: bold">else</span>
            {
              USE_SERIAL.printf(<span style="background-color: #fff0f0">&quot; failed, error: %s</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>, http.errorToString(httpCode).c_str());
              resetFunc(); <span style="color: #888888">//call reset</span>
            }
          }
        }
        <span style="color: #008800; font-weight: bold">else</span>
        {
          web_server();
      
          <span style="color: #888888">//    set_time();</span>
      
          set_alarm();
          <span style="color: #888888">// send_time();</span>
      
        }
        delay(<span style="color: #0000DD; font-weight: bold">500</span>);
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">web_server</span>() {
        <span style="color: #888888">// TODO: check if connected</span>
      <span style="color: #888888">//  if ((WiFiMulti.run() != WL_CONNECTED))</span>
      <span style="color: #888888">//  {</span>
      <span style="color: #888888">//    // attempt to connect</span>
      <span style="color: #888888">//    WiFi.reconnect();</span>
      <span style="color: #888888">//  }</span>
        
        WiFiClient client <span style="color: #333333">=</span> server.available();
        <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>client) {
          <span style="color: #008800; font-weight: bold">return</span>;
        }
      
        <span style="color: #888888">// Wait until the client sends some data</span>
        USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;new client&quot;</span>);
        <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>client.available()) {
          <span style="color: #008800; font-weight: bold">return</span>;
        }
      
        <span style="color: #888888">// Read the first line of the request</span>
        String req <span style="color: #333333">=</span> client.readStringUntil(<span style="color: #0044DD">&#39;\r&#39;</span>);
        USE_SERIAL.println(req);
        client.flush();
      
      
      
        <span style="color: #888888">// Prepare the response</span>
        String s <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;HTTP/1.1 200 OK</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\r\n</span><span style="background-color: #fff0f0">Access-Control-Allow-Origin: *</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\r\n</span><span style="background-color: #fff0f0">Content-Type: text/html</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\r\n\r\n</span><span style="background-color: #fff0f0">&quot;</span>;
      
      
        <span style="color: #888888">// Match the request</span>
        <span style="color: #333399; font-weight: bold">int</span> val <span style="color: #333333">=</span> digitalRead(LED_BUILTIN);
        <span style="color: #333399; font-weight: bold">char</span> buffer[<span style="color: #0000DD; font-weight: bold">45</span>];
        <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/gpio/0&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>)
          val <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/gpio/1&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>)
          val <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/getconfig/&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #888888">// read configuration</span>
        {
          sprintf(buffer, <span style="background-color: #fff0f0">&quot;{</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">on</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">:%d, </span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">End</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">:</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">%d:%d</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">, </span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">Week</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">:</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">%d:%d</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\&quot;</span><span style="background-color: #fff0f0">}&quot;</span>, enabled, end_hour, end_minute, week_hour, week_minute);
          USE_SERIAL.println(buffer);
          s <span style="color: #333333">+=</span> buffer;
        }
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/alarm/0&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #888888">// turn alarm off</span>
        {
          disable();
          s <span style="color: #333333">+=</span> <span style="background-color: #fff0f0">&quot;ACK&quot;</span>;
        }
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/alarm/1&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #888888">// turn alarm on</span>
        {
          enable();
          s <span style="color: #333333">+=</span> <span style="background-color: #fff0f0">&quot;ACK&quot;</span>;
        }
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/week/&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #888888">// set the week day time</span>
        {
          <span style="color: #333399; font-weight: bold">int</span> index <span style="color: #333333">=</span> req.indexOf(<span style="background-color: #fff0f0">&quot;/week/&quot;</span>) <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">6</span>;
          <span style="color: #333399; font-weight: bold">int</span> colon <span style="color: #333333">=</span> req.indexOf(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
          String hour_str <span style="color: #333333">=</span> req.substring(index, colon);
          String min_str <span style="color: #333333">=</span> req.substring(colon <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>);
          <span style="color: #333399; font-weight: bold">int</span> space <span style="color: #333333">=</span> min_str.indexOf(<span style="background-color: #fff0f0">&quot; &quot;</span>);
          min_str <span style="color: #333333">=</span> min_str.substring(<span style="color: #0000DD; font-weight: bold">0</span>, space);
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;Set week day&gt; &quot;</span>);
          USE_SERIAL.print(hour_str);
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
          USE_SERIAL.println(min_str);
          set_week_alarm(hour_str.toInt(), min_str.toInt());
        }
        <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (req.indexOf(<span style="background-color: #fff0f0">&quot;/end/&quot;</span>) <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #888888">// set the week day time</span>
        {
          <span style="color: #333399; font-weight: bold">int</span> index <span style="color: #333333">=</span> req.indexOf(<span style="background-color: #fff0f0">&quot;/end/&quot;</span>) <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">5</span>;
          <span style="color: #333399; font-weight: bold">int</span> colon <span style="color: #333333">=</span> req.indexOf(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
          String hour_str <span style="color: #333333">=</span> req.substring(index, colon);
          String min_str <span style="color: #333333">=</span> req.substring(colon <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>);
          <span style="color: #333399; font-weight: bold">int</span> space <span style="color: #333333">=</span> min_str.indexOf(<span style="background-color: #fff0f0">&quot; &quot;</span>);
          min_str <span style="color: #333333">=</span> min_str.substring(<span style="color: #0000DD; font-weight: bold">0</span>, space);
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;Set week end&gt; &quot;</span>);
          USE_SERIAL.print(hour_str);
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
          USE_SERIAL.println(min_str);
          set_weekend_alarm(hour_str.toInt(), min_str.toInt());
        }
        <span style="color: #008800; font-weight: bold">else</span> {
          USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;invalid request&quot;</span>);
          client.stop();
          <span style="color: #008800; font-weight: bold">return</span>;
        }
        s <span style="color: #333333">+=</span> <span style="background-color: #fff0f0">&quot;</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>;
      
        <span style="color: #888888">// Set GPIO2 according to the request</span>
        digitalWrite(LED_BUILTIN, val);
      
        client.flush();
      
      
      
        <span style="color: #888888">// Send the response to the client</span>
        client.print(s);
        delay(<span style="color: #0000DD; font-weight: bold">1</span>);
        USE_SERIAL.println(<span style="background-color: #fff0f0">&quot;Client disonnected&quot;</span>);
      
        <span style="color: #888888">// The client will actually be disconnected</span>
        <span style="color: #888888">// when the function returns and &#39;client&#39; object is detroyed</span>
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">disable</span>()
      {
        enabled <span style="color: #333333">=</span> <span style="color: #007020">false</span>;
        <span style="color: #888888">// store in eeprom</span>
        EEPROM.write(ENABLED_ADDR, enabled);
        EEPROM.commit();
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">enable</span>()
      {
        enabled <span style="color: #333333">=</span> <span style="color: #007020">true</span>;
        <span style="color: #888888">// store in eeprom</span>
        EEPROM.write(ENABLED_ADDR, enabled);
        EEPROM.commit();
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">set_week_alarm</span>(<span style="color: #333399; font-weight: bold">int</span> hour, <span style="color: #333399; font-weight: bold">int</span> minute)
      {
        week_hour <span style="color: #333333">=</span> hour;
        week_minute <span style="color: #333333">=</span> minute;
        <span style="color: #888888">// todo: store in eeprom</span>
        EEPROM.write(WEEK_HOUR_ADDR, week_hour);
        EEPROM.write(WEEK_MINUTE_ADDR, week_minute);
        EEPROM.commit();
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">set_weekend_alarm</span>(<span style="color: #333399; font-weight: bold">int</span> hour, <span style="color: #333399; font-weight: bold">int</span> minute)
      {
        end_hour <span style="color: #333333">=</span> hour;
        end_minute <span style="color: #333333">=</span> minute;
        <span style="color: #888888">// todo: store in eeprom</span>
        EEPROM.write(WEEKEND_HOUR_ADDR, end_hour);
        EEPROM.write(WEEKEND_MINUTE_ADDR, end_minute);
        EEPROM.commit();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_hour</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">2</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_minute</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">3</span>, <span style="color: #0000DD; font-weight: bold">5</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_second</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">6</span>, <span style="color: #0000DD; font-weight: bold">8</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_day</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">22</span>, <span style="color: #0000DD; font-weight: bold">24</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_date</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">12</span>, <span style="color: #0000DD; font-weight: bold">14</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_month</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">9</span>, <span style="color: #0000DD; font-weight: bold">11</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">get_year</span>(String in)
      {
        <span style="color: #888888">//19:27:51 02/05/2018 : 1</span>
        String time <span style="color: #333333">=</span> in.substring(<span style="color: #0000DD; font-weight: bold">15</span>, <span style="color: #0000DD; font-weight: bold">19</span>);
        <span style="color: #008800; font-weight: bold">return</span> time.toInt();
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">set_alarm</span>()
      {
        <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #333333">!</span>enabled)
        {
          digitalWrite(D1, LOW);
          <span style="color: #008800; font-weight: bold">return</span>;
        }
        <span style="color: #333399; font-weight: bold">int</span> wakeup <span style="color: #333333">=</span> week_hour;
        <span style="color: #333399; font-weight: bold">int</span> wakeupmin <span style="color: #333333">=</span> week_minute;
        <span style="color: #333399; font-weight: bold">int</span> dow <span style="color: #333333">=</span> weekday() <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>;
        <span style="color: #333399; font-weight: bold">bool</span> is_weekend <span style="color: #333333">=</span> dow <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">||</span> dow <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">6</span>;
        <span style="color: #008800; font-weight: bold">if</span> (is_weekend)
        {
          wakeup <span style="color: #333333">=</span> end_hour;
          wakeupmin <span style="color: #333333">=</span> end_minute;
        }
        <span style="color: #008800; font-weight: bold">if</span> (
          (hour() <span style="color: #333333">&lt;=</span> wakeup) <span style="color: #333333">||</span>
          (hour() <span style="color: #333333">==</span> wakeup <span style="color: #333333">&amp;&amp;</span> minute() <span style="color: #333333">&lt;=</span> wakeupmin))
        {
          <span style="color: #333399; font-weight: bold">float</span> time_diff <span style="color: #333333">=</span> wakeup <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">3600</span> <span style="color: #333333">+</span> wakeupmin <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">60</span>;
          time_diff <span style="color: #333333">=</span> time_diff <span style="color: #333333">-</span> hour() <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">3600</span>;
          time_diff <span style="color: #333333">=</span> time_diff <span style="color: #333333">-</span> minute() <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">60</span>;
          time_diff <span style="color: #333333">=</span> time_diff <span style="color: #333333">-</span> second();
          USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;Time diff: &quot;</span>);
          USE_SERIAL.println(time_diff);
          <span style="color: #008800; font-weight: bold">if</span> (time_diff <span style="color: #333333">&lt;=</span> <span style="color: #0000DD; font-weight: bold">1800</span>)
          {
            <span style="color: #333399; font-weight: bold">int</span> raw;
            <span style="color: #333399; font-weight: bold">int</span> scaled;
            <span style="color: #008800; font-weight: bold">if</span> (time_diff <span style="color: #333333">&lt;=</span> <span style="color: #0000DD; font-weight: bold">0</span>)
            {
              raw <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">100</span>;
              scaled <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">255</span>;
            }
            <span style="color: #008800; font-weight: bold">else</span>
            {
              raw <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">100</span> <span style="color: #333333">-</span> <span style="color: #6600EE; font-weight: bold">.056</span> <span style="color: #333333">*</span> time_diff;
              scaled <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">.01427</span> <span style="color: #333333">*</span> raw <span style="color: #333333">*</span> raw <span style="color: #333333">+</span> <span style="color: #6600EE; font-weight: bold">1.3027</span> <span style="color: #333333">*</span> raw <span style="color: #333333">+</span> <span style="color: #6600EE; font-weight: bold">0.7132</span>;
            }
      
            USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;Setting brightness: &quot;</span>);
            USE_SERIAL.print(raw);
            USE_SERIAL.print(<span style="background-color: #fff0f0">&quot; -&gt; &quot;</span>);
            USE_SERIAL.println(scaled);
            analogWrite(D1, scaled);
          }
          <span style="color: #008800; font-weight: bold">else</span>
          {
            analogWrite(D1, <span style="color: #0000DD; font-weight: bold">0</span>);
          }
        }
        <span style="color: #008800; font-weight: bold">else</span>
        {
          Serial.println(<span style="background-color: #fff0f0">&quot;After alarm&quot;</span>);
          analogWrite(D1, <span style="color: #0000DD; font-weight: bold">0</span>);
        }
      }
      
      <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">send_time</span>()
      {
        USE_SERIAL.print(hour());
        USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
        USE_SERIAL.print(minute());
        USE_SERIAL.print(<span style="background-color: #fff0f0">&quot;:&quot;</span>);
        USE_SERIAL.println(second());
      }
      </pre></td></tr></table></div>
      